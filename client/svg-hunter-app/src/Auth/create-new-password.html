<!DOCTYPE html>
<html>
    <head>
        <title>Change Password</title>
        <link rel="stylesheet" type="text/css" href="resetPassword.css" />
    </head>
    <body>
        <div class="container">
            <h1>Change Password</h1>
            <form id="changePasswordForm">
                <label for="username">Username:</label>
                <input
                    type="text"
                    id="username"
                    name="username"
                    required
                /><br /><br />
                <label for="newPassword">New Password:</label>
                <input
                    type="password"
                    id="newPassword"
                    name="newPassword"
                    required
                /><br /><br />
                <label for="confirmPassword">Confirm Password:</label>
                <input
                    type="password"
                    id="confirmPassword"
                    name="confirmPassword"
                    required
                /><br /><br />
                <label for="email">Email:</label>
                <input
                    type="email"
                    id="email"
                    name="email"
                    required
                /><br /><br />
                <input type="checkbox" id="showPasswordCheckbox" />
                <label for="showPasswordCheckbox">Show Password</label
                ><br /><br />
                <input
                    type="submit"
                    value="Change Password"
                    class="return-to-login-button"
                />
            </form>

            <p id="message"></p>
            <button onclick="redirectToLogin()" class="return-button">
                Return to Login
            </button>
        </div>

        <script>
            function redirectToLogin() {
                location.href = "http://localhost:3000/auth";
            }

            // Function to handle form submission
            async function handleSubmit(event) {
                event.preventDefault(); // Prevent form from being submitted normally

                // Get form values
                const username = document.getElementById("username").value;
                const newPassword =
                    document.getElementById("newPassword").value;
                const confirmPassword =
                    document.getElementById("confirmPassword").value;
                const email = document.getElementById("email").value;

                // Check if the new password matches the confirm password
                if (newPassword !== confirmPassword) {
                    document.getElementById("message").textContent =
                        "Passwords do not match";
                    return;
                }

                // Create a request body object
                const requestBody = {
                    Username: username,
                    NewPassword: newPassword,
                    Email: email,
                };

                try {
                    // Send a PATCH request to the server
                    const response = await fetch(
                        "http://localhost:4000/user/update-password",
                        {
                            method: "PATCH",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify(requestBody),
                        }
                    );

                    // Check the response status
                    if (response.ok) {
                        const data = await response.json();
                        alert("Password change successful! Return To Login"); // Custom alert message
                    } else {
                        const errorData = await response.json();
                        document.getElementById("message").textContent =
                            errorData.message; // Show error message
                    }
                } catch (error) {
                    console.error("Error:", error);
                    document.getElementById("message").textContent =
                        "An error occurred. Please try again."; // Show generic error message
                }
            }

            // Function to toggle password visibility
            function togglePasswordVisibility() {
                const passwordInput = document.getElementById("newPassword");
                const confirmPasswordInput =
                    document.getElementById("confirmPassword");
                const showPasswordCheckbox = document.getElementById(
                    "showPasswordCheckbox"
                );

                if (showPasswordCheckbox.checked) {
                    passwordInput.type = "text";
                    confirmPasswordInput.type = "text";
                } else {
                    passwordInput.type = "password";
                    confirmPasswordInput.type = "password";
                }
            }

            // Add event listeners
            const form = document.getElementById("changePasswordForm");
            form.addEventListener("submit", handleSubmit);

            const showPasswordCheckbox = document.getElementById(
                "showPasswordCheckbox"
            );
            showPasswordCheckbox.addEventListener(
                "change",
                togglePasswordVisibility
            );
        </script>
    </body>
</html>
